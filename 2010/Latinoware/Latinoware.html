<!DOCTYPE html>
<!--
  Copyright 2010 César Rodas (crodas@php.net)

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  Based (layout/styles) on Google's slides for HTML5rocks.
  -----------------------------------------------------

  Copyright 2010 Google, Inc

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  Original slides: Marcin Wichary (mwichary@google.com)
  Modifications: Ernest Delgado (ernestd@google.com)
                 Alex Russell (slightlyoff@chromium.org)
                 Brad Neuberg
-->
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge;chrome=1" />
    <title>PHP and MongoDB</title>
    <link href="GoogleFonts.css" rel="stylesheet" type="text/css" />

    <script type="text/javascript" src="js/sh_main.js"></script>
    <script type="text/javascript" src="js/sh_php.min.js"></script>
    <script type="text/javascript" src="js/sh_javascript.min.js"></script>
    <script type="text/javascript" src="js/sh_sql.min.js"></script>
    <link type="text/css" rel="stylesheet" href="css/sh_darkness.css">

    <!-- {{{ styles -->
    <style>
      body {
        font: 16px "Lucida Grande", "Trebuchet MS", Verdana, sans-serif;
        padding: 0;
        margin: 0;
        width: 100%;
        height: 100%;
        position: absolute;
        left: 0px; top: 0px;
      }

      .presentation {
        position: absolute;
        height: 100%;
        width: 100%;
        left: 0px;
        top: 0px;
        display: block;
        overflow: hidden;
        background: #778;
      }

      .slides {
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
        position: absolute;
        display: block;
        -webkit-transition: -webkit-transform 1s ease-in-out;
        -moz-transition: -moz-transform 1s ease-in-out;
        -o-transition: -o-transform 1s ease-in-out;
        transition: transform 1s ease-in-out;
      }

      .slide {
        display: none;
        position: absolute;
        overflow: hidden;
        width: 900px;
        height: 700px;
        left: 50%;
        top: 50%;
        margin-top: -350px;
        background-color: #eee;
        background: -webkit-gradient(linear, left bottom, left top, from(#bbd), to(#fff));
        background: -moz-linear-gradient(bottom, #bbd, #fff);
        background: linear-gradient(bottom, #bbd, #fff);
        -webkit-transition: margin 0.25s ease-in-out;
        -moz-transition: margin 0.25s ease-in-out;
        -o-transition: margin 0.25s ease-in-out;
        transition: margin 0.25s ease-in-out;
      }

      .slide:nth-child(even) {
        -moz-border-radius: 20px 0;
        -khtml-border-radius: 20px 0;
        border-radius: 20px 0; /* includes Opera 10.5+ */
        -webkit-border-top-left-radius: 20px;
        -webkit-border-bottom-right-radius: 20px;
      }

      .slide:nth-child(odd) {
        -moz-border-radius: 0 20px;
        -khtml-border-radius: 0 20px;
        border-radius: 0 20px;
        -webkit-border-top-right-radius: 20px;
        -webkit-border-bottom-left-radius: 20px;
      }

      .slide p, .slide textarea {
        font-size: 20px;
      }

      .slide .counter {
        color: #999999;
        position: absolute;
        left: 20px;
        bottom: 20px;
        display: block;
        font-size: 12px;
      }

      .slide.title > .counter,
      .slide.segue > .counter,
      .slide.mainTitle > .counter {
        display: none;
      }

      .force-render {
        display: block;
        visibility: hidden;
      }
      
      .slide.far-past {
        display: block;
        margin-left: -2400px;
      }
      
      .slide.past {
        visibility: visible;
        display: block;
        margin-left: -1400px;
      }
      
      .slide.current {
        visibility: visible;
        display: block;
        margin-left: -450px;
      }
      
      .slide.future {
        visibility: visible;
        display: block;
        margin-left: 500px;
      }
      
      .slide.far-future {
        display: block;
        margin-left: 1500px;
      }

      body.three-d div.presentation {
        /*background: -webkit-gradient(radial, 50% 50%, 10, 50% 50%, 1000, from(#333), to(#000));        */
      }
      
      body.three-d div.slides {
        -webkit-transform: translateX(50px) scale(0.8) rotateY(10deg);
        -moz-transform: translateX(50px) scale(0.8) rotateY(10deg);
        -o-transform: translateX(50px) scale(0.8) rotateY(10deg);
        transform: translateX(50px) scale(0.8) rotateY(10deg);
      }
      
      /* Content */
      /*
        Font sizes:
        header h1 - 50px
        h2, p - 20px
        default, pre, input - 16px
      */
      
      @font-face { font-family: 'Junction'; src: url(src/Junction02.otf); }
      @font-face { font-family: 'LeagueGothic'; src: url(src/LeagueGothic.otf); }
      
      header {
        font-family: 'Droid Sans';
        font-weight: normal;
        letter-spacing: -.05em;
        color: black;
        text-shadow: rgba(0, 0, 0, 0.2) 0 2px 5px;
        position: absolute;
        left: 30px;
        top: 25px;
        margin: 0;
        padding: 0;
        font-size: 50px;
      }
      
      h1 {
        font-size: 100%;
        display: inline;
      	font-weight: normal;
      	padding: 0;
      	margin: 0;
      }
      
      h2 {
        font-family: 'Droid Sans';
        color: black;
        font-size: 20px;
        padding: 0;
        margin: 15px 0 5px 0;
      }
            
      h2:first-child {
        margin-top: 0;
      }

      section, footer {
        font-family: 'Droid Sans';
        color: #3f3f3f;
        text-shadow: rgba(0, 0, 0, 0.2) 0 2px 5px;
        margin: 100px 30px 0;
        display: block;
        overflow: hidden;
      }
      
      footer {
        font-size: 12px;
        margin: 20px 0 0 30px;
      }

      a {
        color: inherit;
        display: inline-block;
        text-decoration: none;
        line-height: 110%;
        border-bottom: 2px solid #3f3f3f;
      }

      .gmap a {
        line-height: 100%;
        border-bottom: none;
      }

      li {
        list-style: none;
        padding: 10px 0;
      }

      button {
        font-size: 20px;
      }
      
      pre button {
        margin: 2px;
      }
      
      .summary {
        font-size: 30px;
      }

      .bullets {
        font-size: 40px;
      }
      
      section.left {
        float: left;
        width: 390px;
      }
      
      section.small {
        font-size: 24px;
      }
      
      section.small ul {
        margin: 0 0 0 15px;
        padding: 0;
      }
      
      section.small li {
        padding-bottom: 0;
      }
            
      section.middle {
        line-height: 68px;
        text-align: center;
        display: table-cell;
        vertical-align: middle;
        height: 700px;
        width: 900px;
      }
      
      pre {
        text-align: left;
        font-family: 'Droid Sans Mono', Courier;        
        padding: 10px 20px;
        background: rgba(255, 0, 0, 0.05);
        -webkit-border-radius: 8px;
        -khtml-border-radius: 8px;
        -moz-border-radius: 8px;
        border-radius: 8px;
        border: 1px solid rgba(255, 0, 0, 0.2);
      }
      
      pre select {
        font-family: Monaco, Courier;
        border: 1px solid #c61800;
      }
        
      input {
        font-size: 16px;
        margin-right: 10px;
        font-family: Helvetica;
        padding: 3px;
      }
      input[type="range"] {
        width: 100%;
      }
      
      button {
        margin: 20px 10px 0 0;
        font-family: Verdana;
      }
      
      button.large {
        font-size: 32px;
      }
        
      pre b {
        font-weight: normal;
        color: #c61800;
        text-shadow: #c61800 0 0 1px;
        /*letter-spacing: -1px;*/
      }
      pre em {
        font-weight: normal;
        font-style: normal;
        color: #18a600;
        text-shadow: #18a600 0 0 1px;
      }
      pre input[type="range"] {
        height: 6px;
        cursor: pointer;
        width: auto;
      }
      
      div.example {
        display: block;
        padding: 10px 20px;
        color: black;
        background: rgba(255, 255, 255, 0.4);
        -webkit-border-radius: 8px;
        -khtml-border-radius: 8px;
        -moz-border-radius: 8px;
        border-radius: 8px;
        margin-bottom: 10px;
        border: 1px solid rgba(0, 0, 0, 0.2);
      }
      
      video {
        -moz-border-radius: 8px;
        -khtml-border-radius: 8px;
        -webkit-border-radius: 8px;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.2);
      }
      
      .css,
      .js,
      .html,
      .key {
        font-family: 'Droid Sans';
        color: black;
        display: inline-block;
        padding: 6px 10px 3px 10px;
        font-size: 25px;
        line-height: 30px;
        text-shadow: none;
        letter-spacing: 0;
        bottom: 10px;
        position: relative;
        -moz-border-radius: 10px;
        -khtml-border-radius: 10px;
        -webkit-border-radius: 10px;
        border-radius: 10px;
        background: white;
        box-shadow: rgba(0, 0, 0, 0.1) 0 2px 5px;
        -webkit-box-shadow: rgba(0, 0, 0, 0.1) 0 2px 5px;
        -moz-box-shadow: rgba(0, 0, 0, 0.1) 0 2px 5px;
        -o-box-shadow: rgba(0, 0, 0, 0.1) 0 2px 5px;
      }
      
      .key { font-family: Arial; }
      
      :not(header) > .css,
      :not(header) > .js,
      :not(header) > .html,
      :not(header) > .key {
        margin: 0 5px;
        bottom: 4px;
      }
      
      .css {
        background: -webkit-gradient(linear, left top, left bottom, from(#ff4), to(#ffa));
        background-color: #ff4;
        background: -moz-linear-gradient(left top, #ff4, #ffa);
      }
      .js {
        background: -webkit-gradient(linear, left top, left bottom, from(#4f4), to(#afa));
        background-color: #4f4;
        background: -moz-linear-gradient(left top, #4f4, #afa);
      }
      .html {
        background: -webkit-gradient(linear, left top, left bottom, from(#e88), to(#fee));
        background-color: #e88;
        background: -moz-linear-gradient(left top, #e88, #fee);
      }

      .two-column {
        -webkit-column-count: 2;
        -moz-column-count: 2;
        column-count: 2;
      }
      
      .summary li::before, .bullets li::before {
        content: '· ';
      }

      .stroke {
        -webkit-text-stroke-color: red;
        -webkit-text-stroke-width: 1px;
      } /* currently webkit-only */
      
      .center {
        text-align: center;
      }
      
      .formula {
        font-size: 50px;
      }
      
      #presentation-counter {
        color: #ccc;
        font-size: 100px;
        letter-spacing: 1px;
        position: absolute;
        top: 40%;
        left: 0;
        width: 100%;
        text-align: center;
      }
      
      .hsl-value {
        display: inline-block;
        width: 50px;
      }
    </style>
    <!-- }}} slides -->
    
  </head>
  <body onload="sh_highlightDocument();">
    <div class="presentation">
      <div id="presentation-counter"></div>
      <div class="slides">
        <div class="slide">
          <style>
            .landing p {
              font-size: 35px;
            }
            #disclaimer-message {
              font-size: 20px;
            }
          </style>
          <section class="middle landing">
            <p>This presentation is an HTML5 website</p>
            <p>Press <span class="key">&rarr;</span> key to advance.</p>
            <p>Zoom in/out: <span class="key">Ctrl or Command</span> + <span class="key">+/-</span></p>
            <p id="disclaimer-message">This slide uses styles/codes from Google's slides for <a href="http://slides.html5rocks.com/">HTML5</a></p>
          </section>
        </div>
                
        <div class="slide">
          <style>
            .intro h1, .intro h2 {
              color: black;
            }
            .intro h1 {
              letter-spacing: -2px;
              font-size: 96px;
            }
            .intro h2 {
              margin-top: -5px;
              font-size: 40px;
              letter-spacing: -1px;
            }
          </style>
          <section class="middle intro">
            <hgroup>
              <h1>
                PHP and MongoDB
              </h1>
              <h2>
                Dropping SQL and thinking in objects
              </h2>
            </hgroup>
            <p>
                César Rodas - <a href="mailto:crodas@php.net">crodas@php.net</a><br/>
                Latinoware 2010
            </p>
            <p>&nbsp;</p>
            <p id="disclaimer-message"><em>This slides are Open source (Apache License) feel free to reuse it as you wish.</em></p>
          </section>
        </div>


        <div class="slide">
          <header>About me</header>
          <section>
            <style>
              span.year {
                display: inline-block;
                text-align: right;
                width: 120px;
                letter-spacing: -2px;
                padding-right: 10px;
              }
              hr {
                visibility: hidden;
                padding: 0;
                margin: 0 0 -20px 0;
              }
              #timeline {
                font-size: 50px;
              }
              #timeline li {
                padding: 0;
              }
            </style>
            
            <ul id="timeline">
              <li><span class="year">1987</span> <span class="html">Born</span></li>
              <li><span class="year">2003</span> <span class="css">PHP</span></li>
              <li><span class="year">2005</span> <span class="css">PHP</span> + <span class="js">Opensource</span></li>
              <li><span class="year">2009</span> <span class="html">MongoDB</span></li>
              <li><span class="year">2010</span> <span class="css">PHP</span> + <span class="js">Opensource</span> + <span class="html">MongoDB</span></li>
            </ul>            
          </section>
        </div>

        
        <div class="slide">
          <section class="middle formula">
            $crodas ~=
            <span class="css">PHP</span>
            +
            <span class="html">MongoDB</span>
            +
            <span class="js">(NodeJS|C)</span>
          </section>
        </div>
        

        <div class="slide">
          <section class="middle">
            <h1>
              <span class="html">MongoDB</span>
            </h1>
          </section>
        </div>


        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>What is it?</h1></header>

          <section>
            <ul class="summary">
              <li><em>MongoDB (EN)</em> != <em>MongoDB(PT)</em> 
              </li><li><em>Document</em> oriented database
              </li><li>Fast, scalable and easy to use (devel-friendly)
              </li><li>Support indexes
              </li><li>Schemaless
              </li><li>Sharding
              </li><li>Replicated
              </li><li>Support nested-documents
              </li><li>PECL client (C driver for PHP)
            </li></ul>
          </section>
        </div>

        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>What is document?</h1></header>

        <section>
        <h2>It is an array/hash/object (without methods) that can be saved in the DB</h2>
<pre class="sh_php">
// a <em>document</em> about me...
$crodas = array(
    <strong>'_id'</strong> =&gt; 'py-4290392',
    'name' =&gt; 'Cesar',
    'surname' =&gt; 'Rodas',
    'e-mail' =&gt; 'crodas@php.net',
    'works' =&gt; array(
        array('name' =&gt; 'PlumWillow', 'obj' =&gt; 'we are hiring'),
        array('name' =&gt; 'Some open source projects', 'obj' =&gt; 'I like it!'),
    )
);

// we save it
$db-&gt;users-&gt;save($crodas);

// we fetch it
$db-&gt;users-&gt;find(array('e-mail' =&gt; 'crodas@php.net'));

// or much better 
$db-&gt;users-&gt;find(array('works.name' =&gt; 'PlumWillow'));

</pre>
</section>
        </div>

        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Operations (Selects)</h1></header>

          <section>
            <ul class="summary">
              <li><strong>$gt, $lt, $gte, $lte, $eq, $neq</strong>: &gt;, &lt;, &gt;=, &lt;=, ==, !=
              </li><li><strong>$in, $nin, $or, $min, $max, $all, $exists</strong>
              </li><li><strong>$where</strong>: (and javascript code)
              </li><li><strong>group()</strong>
              </li><li><strong>distinct()</strong>
              </li><li><strong>skip()</strong>
              </li><li><strong>limit()</strong>
              </li><li><strong>count()</strong>
            </li></ul>
          </section>
        </div>


        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Operations (Update)</h1></header>

          <section>
            <ul class="summary">
              <li><strong>$set, $unset</strong>
              </li><li><strong>$push, $pull</strong>
              </li><li><strong>$inc</strong>
              </li><li><strong>findAndModify()</strong>
            </li></ul>
          </section>
        </div>

        <div class="slide">

          <section class="middle intro">
            <h2>Is it better than my <em>relational</em> database?</h2>
          </section>
        </div>


        <div class="slide">

          <section class="middle intro">
            <h2>No.</h2>
          </section>
        </div>

        <div class="slide">

          <section class="middle intro">
            <h2>It is different.</h2>
          </section>
        </div>

        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Differences</h1></header>

          <section>
            <ul class="summary">
              <li>Denormalize data is not bad
                <ul>
                    <li>It makes queries simplest and fast</li>
                    <li>Disk-space is much cheaper than CPU</li>
                    <li>Much simpler to distribute data across multiple nodes</li>
                </ul>
              </li><li>No CPU wasting doing ORM
              </li><li>No SQL injection
              </li><li>No Joins (they are evil!)
              </li><li>Batch processing
              </li><li>No <em>CREATE TABLE</em> and <em>ALTER TABLE</em>
            </li></ul>
          </section>
        </div>

        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Differences</h1></header>

          <section class="middle">
            <img src="relation.png" />
          </section>
        </div>


        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Data structure</h1></header>

        <section>
<pre class="sh_php">
$user = array(
    'name' =&gt; 'crodas',
    'email' =&gt; 'crodas@php.net',
    'website' =&gt; 'http://cesarodas.com',
);

$category = array(
    'name' =&gt; 'Sport', 
    'description' =&gt; 'Everything about football (proper football)',
);

$comment = array(
    'news' =&gt; $news['_id'],
    'text' =&gt; 'I like MongoDB',
    'user' =&gt; $user['_id'],
    // duplicate properties from user object (to avoid joins)
    'name' =&gt; $user['name'],
    'website' =&gt; $user['website'],
);
</pre>
</section>
        </div>

        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Data structure</h1></header>

        <section>
<pre class="sh_php">
$news = array(
    'title' =&gt; 'My Talk about MongoDB',
    'content' =&gt; 'MongoDB rules, I like it, bla, bla... ',
    'author' =&gt; $user['_id'],

    // duplicate name
    'authorName' =&gt; $user['name'],

    // copy all categories (entire structure) here
    'categories' =&gt; array(
        $category[1], $category[2]
    ),

    // copy first 10 comments
    // (suppose we show 10 first comments, then we paginate it)
    'comments' =&gt; array(
        $comment[0], $comment[1], $comment[2] .. $comment[9]
    ),

    // we update this for every new comment
    'totalComments' =&gt; $db-&gt;comments-&gt;count(array('news' =&gt; $news['_id'])),
);
</pre>
</section>
        </div>

        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Comparing</h1></header>

        <section>
          <h2>Get one news by its ID</h2>
<h2>MySQL</h2>
<pre class="sh_sql">
SELECT news.*, user.name FROM news INNER JOIN user ON user.id = news.author id
WHERE id = 1

SELECT category.category FROM category has news INNER JOIN category ON category
WHERE news id = 1

SELECT * FROM comments INNER JOIN user ON user.id = comments.user id
WHERE news id = 1
</pre>
<h2>MongoDB</h2>
<pre class="sh_php">
$mongo = new MongoDB;
$db = $mongo-&gt;database;

$news = $db-&gt;news-&gt;find(array('_id' =&gt; 1));
</pre>
</section>
        </div>

        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Comparing</h1></header>

        <section>
          <h2>Get 10-most commented news with more than 10 comments</h2>
<h2>MySQL</h2>
<pre class="sh_php">
// Too bored to think in SQL right now
</pre>
<h2>MongoDB</h2>
<pre class="sh_php">
$query = array('totalComments' =&gt; array('$gt' =&gt; 10));
$news  = $db-&gt;news-&gt;find($query)-&gt;sort(array('totalComments' =&gt; -1))-&gt;limit(5);
</pre>
</section>
        </div>

        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Add a new comment</h1></header>

        <section>
<pre class="sh_php">
// Fetch news
$news = $db-&gt;news-&gt;findOne(array(
    '_id' =&gt; $_POST['news_id'],            
), array('totalComments' =&gt; true));

if (empty($news)) throw new Exception("News is not valid");

// Add new comment 
$comment = array(
    'user' =&gt; $_SESSION['user']['_id'],
    'name' =&gt; $_SESSION['user']['name'],
    'website' =&gt; $_SESSION['user']['website'],
    'content' =&gt; $_POST['comment'],
);
$db-&gt;comment-&gt;save($comment);

// Update totalComments
$update = array('$inc' =&gt; array('totalComments' =&gt; 1));
if ($news['totalComments'] < 10) {
    // Should this be cashed in the news document?
    $update['$push'] = array('comments' => $comment);
}
$db-&gt;news-&gt;update(array('_id' =&gt; $news['_id']), $update);
</pre>
</section>
        </div>

        <div class="slide">
          <section class="middle intro">
            <h2>What if the user changes its name?</h2>
          </section>
        </div>


        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Update cached properties</h1></header>

        <section>
<pre class="sh_php">
$update = array(
    '$set' =&gt; array('name' =&gt; $new_name)
);
$option = array('multiple' =&gt; true);

// update in comments collection
$db-&gt;comments-&gt;update(array('user' =&gt; $user_id), $update, $option);

//
$update = array('$set' =&gt; array('comments.name' =&gt; $new name));
$db-&gt;news-&gt;update(array('comments.user' =&gt; $user_id), $update, $option); 

//
$update = array('$set' =&gt; array('authorName' =&gt; $new_name));
$db-&gt;news-&gt;update(array('author' =&gt; $user_id), $update, $option));

</pre>
</section>
        </div>

        <div class="slide">

          <section class="middle intro">
            <h2>What about schema migration?</h2>
          </section>
        </div>


        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Update schema</h1></header>

        <section>
<pre class="sh_php">
// MongoDB (simple version – one node)
foreach ($db-&gt;news-&gt;find() as $news) {
    $query = array('_id' =&gt; $news['_id']);
    $update = array('$set' =&gt;
        array('url' =&gt; get_url_from_title($news['title']))
    );
    $db-&gt;news-&gt;update($query, $update);
}
</pre>
</section>
        </div>

        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Update schema</h1></header>

        <section>
<pre class="sh_php">
// better approach (can run multiple instances safely)
while (true) {
    $news = $db-&gt;command(array(
        'findAndModify' =&gt; 'news',
        // where url doesn't exists (much better than $exists => false)
        'query' =&gt; array('url' =&gt; null),
            // set a new value for url, diff than null
            'update' =&gt; array('$set' =&gt; array('url' =&gt; ' ')),
    ));
    if ($news['ok'] != 1) break;

    $query = array('_id' =&gt; $news['value']['_id']):
    $update = array('$set' =&gt;
        array('url' =&gt; get_url_from_title($news['value']['title']))
    );
    $db-&gt;news-&gt;update($query, $update);
}

</pre>
</section>
        </div>

        <div class="slide">
          <section class="middle intro">
            <h2>Beyond SQL!</h2>
          </section>
        </div>

        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Store file</h1></header>

          <section>
            <ul class="summary">
              <li>No need of any distributed File system
              </li><li>Each file has a checksum
              </li><li>Open data structure
              </li><li>You can extend it to support locking
              </li><li>You can save as much meta data as you want
              </li><li>Works in a sharded-environment
              </li><li>Native extension for <a href="https://github.com/mdirolf/nginx-gridfs/">NGINX</a>
            </li></ul>
          </section>
        </div>

        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Storing file</h1></header>

        <section>
<pre class="sh_php">
$grid = $db-&gt;getGridFS();
$metadata = array(
    "whatever" =&gt; "metadata",
    "path" =&gt; "/foo",
    "download" =&gt; 0
);

$grid-&gt;storeFile($filename, $metadata);

// or
$grid-&gt;storeBytes($bytes, $metadata);

// Or (save $ FILE['foo'])
$grid-&gt;storeUpload('foo', $metadata);

</pre>
</section>
        </div>

        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Read file</h1></header>

        <section>
<pre class="sh_php">
$grid = $db-&gt;getGridFS();
$file = $grid-&gt;findOne(array('path' =&gt; '/foo'));

// update download
$update = array('$inc' =&gt; array('download' =&gt; 1));
$id = array(' id' =&gt; $file-&gt;file[' id']);
$grid-&gt;update($id, $update);

// print it
echo $file-&gt;Bytes();

// or (a bit better)
$tmp = '/tmp/apache/' . $file-&gt;file[' id'];
if (!is_file($tmp)) $file-&gt;write($tmp);
virtual($tmp);

</pre>
</section>
        </div>

        <div class="slide">
          <section class="middle intro">
            <h2>Map/Reduce</h2>
          </section>
        </div>

        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Map/Reduce</h1></header>

          <section>
            <ul class="summary">
              <li>Well known (Google’s) approach to process tons of data
              </li><li>Move the computation where the data is
              </li><li>Similar to GROUP BY, but more powerful (Javascript)
              </li><li>One function is applied to each news (map)
              </li><li>Map() produces 0 to N new values (key, value)
              </li><li>MongoDB sort everything by key
              </li><li>Reduce is called for each (key, values) and return 1 value
            </li></ul>
          </section>
        </div>

        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Map/Reduce</h1></header>

        <section>
<pre class="sh_javascript">
var map = function() {
    if (!this.categories) {
        return;
    }
    for (index in this.categories) {
        // return (several times) a new document
        // with id: category name, and value: 1
        emit(this.categories[index].name, 1);
    }
};
</pre>
<pre class="sh_javascript">
var reduce = function(key, values) {
    var count = 0;
    for (index in values) {
        count += values[index];
    }
    return count;
};
</pre>
</section>
        </div>
        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Replica sets</h1></header>

          <section>
            <ul class="summary">
              <li>Advanced master/slave replication
              </li><li>Automatic failover and recovery
              </li><li>(optional) REST interface
              </li><li>A write is only truly committed once it has been replicated to a majority of members of the set
              </li><li>Perfect solution for apps. with high number of reads
            </li></ul>
          </section>
        </div>

        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Sharding</h1></header>

          <section>
            <ul class="summary">
              <li>One logical collection, several physical collection
              </li><li>Horizontal scaling across multiple node
              </li><li>Data partition is done by using a partition key
              </li><li>Can be combined with replica sets
            </li></ul>
          </section>
        </div>

        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Sharding</h1></header>

          <section>
<pre class="sh_javascript">
// Shard key
{ x : 1}

// Targeted
db.foo.find( { x : 300 } ) 
db.foo.find( { x : 300, age : 40 } )    
db.foo.insert( &lt;object&gt; ) 
db.foo.update( { x : 100 }, &lt;object&gt; ) 
db.foo.remove( { x : 100 } ) 


// Global
db.foo.find( { age : 40 } ) 
db.foo.find() // sequential
db.foo.find(...).sort( { age : 1 } ) 
db.foo.update( { age : 40 }, &lt;object&gt; ) 
db.foo.remove( { age : 40 } )
</pre>
          </section>
        </div>

        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Capped Collections</h1></header>

          <section>
            <ul class="summary">
              <li>Fixed sized collections, high performance auto-FIFO age-out feature.
              </li><li>You may insert new objects in the capped collection.
              </li><li>The database does not allow deleting objects from a capped collection.
              </li><li>Logging, Caching, Auto Archiving.
            </li></ul>
          </section>
        </div>

        <div class="slide">
          <style>
            p.resource-link {
              font-size: 40px;
            }
            p.resource-link a {
              color: blue;
              text-decoration: underline;
              border: none;
              clear: both;
            }
          </style>
          <section class="middle formula">
            Mongo ~=
            <span class="css">Documents</span>
            +
            <span class="html">Replicated|Distributed</span>
            +
            <span class="js">JS</span>
            <p>
              MongoDB <em class="stroke">=</em> the future of web-development
            </p>
            <p class="resource-link">
              <a href="http://mongodb.org/">http://mongodb.org/</a><br />
              <a href="http://github.com/crodas">http://github.com/crodas</a>
            </p>
          </section>
        </div>

        <div class="slide">
          <section class="middle intro">
            <h2>Questions?</h2>
            <h2><a href="mailto:crodas@php.net"><em>crodas@php.net</em></a></h2>
          </section>
        </div>

        <div class="slide">
          <header><span class="js">MongoDB</span> <h1>Useful projects</h1></header>

          <section>
            <ul class="summary">
              <li>Vork framework
              </li><li>phpMoAdmin
              </li><li><em>ActiveMongo</em> (the devel branch)
              </li><li>Apache Solr
            </li></ul>
          </section>
        </div>


      </div> <!-- slides -->

    </div> <!-- presentation -->

    <!-- {{{ Javascript -->
    <script>
      (function() {
        var doc = document;
        var disableBuilds = true;

        var ctr = 0;
        var spaces = /\s+/, a1 = [''];

        var toArray = function(list) {
          return Array.prototype.slice.call(list || [], 0);
        };

        var byId = function(id) {
          if (typeof id == 'string') { return doc.getElementById(id); }
          return id;
        };

        var query = function(query, root) {
          if (!query) { return []; }
          if (typeof query != 'string') { return toArray(query); }
          if (typeof root == 'string') {
            root = byId(root);
            if(!root){ return []; }
          }

          root = root || document;
          var rootIsDoc = (root.nodeType == 9);
          var doc = rootIsDoc ? root : (root.ownerDocument || document);

          // rewrite the query to be ID rooted
          if (!rootIsDoc || ('>~+'.indexOf(query.charAt(0)) >= 0)) {
            root.id = root.id || ('qUnique' + (ctr++));
            query = '#' + root.id + ' ' + query;
          }
          // don't choke on something like ".yada.yada >"
          if ('>~+'.indexOf(query.slice(-1)) >= 0) { query += ' *'; }

          return toArray(doc.querySelectorAll(query));
        };

        var strToArray = function(s) {
          if (typeof s == 'string' || s instanceof String) {
            if (s.indexOf(' ') < 0) {
              a1[0] = s;
              return a1;
            } else {
              return s.split(spaces);
            }
          }
          return s;
        };

        var addClass = function(node, classStr) {
          classStr = strToArray(classStr);
          var cls = ' ' + node.className + ' ';
          for (var i = 0, len = classStr.length, c; i < len; ++i) {
            c = classStr[i];
            if (c && cls.indexOf(' ' + c + ' ') < 0) {
              cls += c + ' ';
            }
          }
          node.className = cls.trim();
        };

        var removeClass = function(node, classStr) {
          var cls;
          if (classStr !== undefined) {
            classStr = strToArray(classStr);
            cls = ' ' + node.className + ' ';
            for (var i = 0, len = classStr.length; i < len; ++i) {
              cls = cls.replace(' ' + classStr[i] + ' ', ' ');
            }
            cls = cls.trim();
          } else {
            cls = '';
          }
          if (node.className != cls) {
            node.className = cls;
          }
        };

        var toggleClass = function(node, classStr) {
          var cls = ' ' + node.className + ' ';
          if (cls.indexOf(' ' + classStr.trim() + ' ') >= 0) {
            removeClass(node, classStr);
          } else {
            addClass(node, classStr);
          }
        };

        var ua = navigator.userAgent;
        var isFF = parseFloat(ua.split('Firefox/')[1]) || undefined;
        var isWK = parseFloat(ua.split('WebKit/')[1]) || undefined;
        var isOpera = parseFloat(ua.split('Opera/')[1]) || undefined;

        var canTransition = (function() {
          var ver = parseFloat(ua.split('Version/')[1]) || undefined;
          // test to determine if this browser can handle CSS transitions.
          var cachedCanTransition = 
            (isWK || (isFF && isFF > 3.6 ) || (isOpera && ver >= 10.5));
          return function() { return cachedCanTransition; }
        })();

        //
        // Slide class
        //
        var Slide = function(node, idx) {
          this._node = node;
          if (idx >= 0) {
            this._count = idx + 1;
          }
          if (this._node) {
            addClass(this._node, 'slide distant-slide');
          }
          this._makeCounter();
          this._makeBuildList();
        };

        Slide.prototype = {
          _node: null,
          _count: 0,
          _buildList: [],
          _visited: false,
          _currentState: '',
          _states: [ 'distant-slide', 'far-past',
                     'past', 'current', 'future',
                     'far-future', 'distant-slide' ],
          setState: function(state) {
            if (typeof state != 'string') {
              state = this._states[state];
            }
            if (state == 'current' && !this._visited) {
              this._visited = true;
              this._makeBuildList();
            }
            removeClass(this._node, this._states);
            addClass(this._node, state);
            this._currentState = state;

            // delay first auto run. Really wish this were in CSS.
            /*
            this._runAutos();
            */
            var _t = this;
            setTimeout(function(){ _t._runAutos(); } , 400);
          },
          _makeCounter: function() {
            if(!this._count || !this._node) { return; }
            var c = doc.createElement('span');
            c.innerHTML = this._count;
            c.className = 'counter';
            this._node.appendChild(c);
          },
          _makeBuildList: function() {
            this._buildList = [];
            if (disableBuilds) { return; }
            if (this._node) {
              this._buildList = query('[data-build] > *', this._node);
            }
            this._buildList.forEach(function(el) {
              addClass(el, 'to-build');
            });
          },
          _runAutos: function() {
            if (this._currentState != 'current') {
              return;
            }
            // find the next auto, slice it out of the list, and run it
            var idx = -1;
            this._buildList.some(function(n, i) {
              if (n.hasAttribute('data-auto')) {
                idx = i;
                return true;
              }
              return false;
            });
            if (idx >= 0) {
              var elem = this._buildList.splice(idx, 1)[0];
              var transitionEnd = isWK ? 'webkitTransitionEnd' : (isFF ? 'mozTransitionEnd' : 'oTransitionEnd');
              var _t = this;
              if (canTransition()) {
                var l = function(evt) {
                  elem.parentNode.removeEventListener(transitionEnd, l, false);
                  _t._runAutos();
                };
                elem.parentNode.addEventListener(transitionEnd, l, false);
                removeClass(elem, 'to-build');
              } else {
                setTimeout(function() {
                  removeClass(elem, 'to-build');
                  _t._runAutos();
                }, 400);
              }
            }
          },
          buildNext: function() {
            if (!this._buildList.length) {
              return false;
            }
            removeClass(this._buildList.shift(), 'to-build');
            return true;
          },
        };

        //
        // SlideShow class
        //
        var SlideShow = function(slides) {
          this._slides = (slides || []).map(function(el, idx) {
            return new Slide(el, idx);
          });
          var h = window.location.hash;
          try {
            this.current = parseInt(h.split('#slide')[1], 10);
          } catch (e) { /* squeltch */ }
          this.current = isNaN(this.current) ? 1 : this.current;
          var _t = this;
          doc.addEventListener('keydown', 
              function(e) { _t.handleKeys(e); }, false);
          doc.addEventListener('mousewheel', 
              function(e) { _t.handleWheel(e); }, false);
          doc.addEventListener('DOMMouseScroll', 
              function(e) { _t.handleWheel(e); }, false);
          doc.addEventListener('touchstart', 
              function(e) { _t.handleTouchStart(e); }, false);
          doc.addEventListener('touchend', 
              function(e) { _t.handleTouchEnd(e); }, false);
          window.addEventListener('popstate', 
              function(e) { if (e.state) { _t.go(e.state); } }, false);
          this._update();          
        };

        SlideShow.prototype = {
          _slides: [],
          _update: function(dontPush) {
            document.querySelector('#presentation-counter').innerText = this.current;
            if (history.pushState) {
              if (!dontPush) {
                history.replaceState(this.current, 'Slide ' + this.current, '#slide' + this.current);
              }
            } else {
              window.location.hash = 'slide' + this.current;
            }
            for (var x = this.current-1; x < this.current + 7; x++) {
              if (this._slides[x-4]) {
                this._slides[x-4].setState(Math.max(0, x-this.current));
              }
            }
          },

          current: 0,
          next: function() {
            if (!this._slides[this.current-1].buildNext()) {
              this.current = Math.min(this.current + 1, this._slides.length);
              this._update();
            }
          },
          prev: function() {
            this.current = Math.max(this.current-1, 1);
            this._update();
          },
          go: function(num) {
            this.current = num;
            this._update(true);
          },

          _notesOn: false,
          showNotes: function() {
            var isOn = this._notesOn = !this._notesOn;
            query('.notes').forEach(function(el) {
              el.style.display = (notesOn) ? 'block' : 'none';
            });
          },
          switch3D: function() {
            toggleClass(document.body, 'three-d');
          },
          handleWheel: function(e) {
            var delta = 0;
            if (e.wheelDelta) {
              delta = e.wheelDelta/120;
              if (isOpera) {
                delta = -delta;
              }
            } else if (e.detail) {
              delta = -e.detail/3;
            }

            if (delta > 0 ) {
              this.prev();
              return;
            }
            if (delta < 0 ) {
              this.next();
              return;
            }
          },
          handleKeys: function(e) {
            
            if (/^(input|textarea)$/i.test(e.target.nodeName)) return;
            
            switch (e.keyCode) {
              case 71: // g (go to page)
                  this.current = prompt("What page?");
                  this._update();
                  break;
              case 36: // home
                  this.current = 1;
                  this._update();
                  break;
              case 37: // left arrow
              case 33: // PgUp
                this.prev(); break;
                break;
              case 39: // right arrow
              case 32: // space
              case 34: // PgDn
              case 13: // Enter
                this.next(); break;
                break;
              case 50: // 2
                this.showNotes(); break;
                break;
              case 51: // 3
                this.switch3D(); break;
            }
          },
          _touchStartX: 0,
          handleTouchStart: function(e) {
            this._touchStartX = e.touches[0].pageX;
          },
          handleTouchEnd: function(e) {
            var delta = this._touchStartX - e.changedTouches[0].pageX;
            var SWIPE_SIZE = 150;
            if (delta > SWIPE_SIZE) {
              this.next();
            } else if (delta< -SWIPE_SIZE) {
              this.prev();
            }
          },
        };

        // Initialize
        var slideshow = new SlideShow(query('.slide'));
      })();
    </script>

    <!--[if lt IE 9]>
    <script 
      src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js">
    </script>
		<script>CFInstall.check({ mode: "overlay" });</script>
    <![endif]-->
    <!-- }}} -->
    
  </body>
</html>
